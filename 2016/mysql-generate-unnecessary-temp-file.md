## 1 现象
12月1日起观测到某服务器系统盘占用超过90%触发报警，但很快又自发回落，涉及到的文件大小应在3G以上。整个过程一般持续10至15分钟，每数小时出现一次，出现时机似无规律。
## 2 大致问题定位
在问题主机上添加磁盘占用监控脚本，内容包括df及系统盘du信息，每分钟执行一次。观察结果为df显著增长时，du信息无任何变化。<br>
此时yilin提出检查lsof，将lsof写入监控脚本观察。后终有所获。<br>
通过进程号查询可定位问题出现在该主机的mysql实例1上。

## 3 定位问题SQL

Mysql写临时文件的情况有两种，其一是写binlog，其二是查询时使用文件排序或生成临时表。但组内的设置使得binlog并不会打在系统盘内，可能性就只有因查询生成了。这时候就像看慢查询日志，但很遗憾，慢查询功能没开。于是改用土办法：磁盘占用量暴增时脚本连接mysql执行show processlist打出结果。经过漫长的守株待兔，截获这样一条可疑语句：
```sql
select ip_head,ip_tail,isp_id,city_id,province_id from ip_code order by ip_head limit 4500000,14694
```

之后手动执行，确实成功复现系统盘容量暴增的现象。
## SQL优化失效导致的外部排序
查看该数据表的索引信息，发现在用于排序的ip_head字段上是有B+索引的，但查看这条语句的执行计划，却发现执行中并未使用该索引，而是用了外部排序，而目前该数据库的临时文件就是存在/tmp目录。这就解释了为什么这条语句会导致磁盘占用暴增。执行计划如下图：
```
+----+-------------+---------+------+---------------+------+---------+------+---------+----------------+
| id | select_type | table   | type | possible_keys | key  | key_len | ref  | rows    | Extra          |
+----+-------------+---------+------+---------------+------+---------+------+---------+----------------+
|  1 | SIMPLE      | ip_code | ALL  | NULL          | NULL | NULL    | NULL | 4514694 | Using filesort | 
+----+-------------+---------+------+---------------+------+---------+------+---------+----------------+
```
在语句中增加use index (i_ip_head)，并不改变以上结果。改用force index (i_ip_head)，执行计划就比较符合预期：
```
+----+-------------+---------+-------+---------------+-----------+---------+------+---------+-------+
| id | select_type | table   | type  | possible_keys | key       | key_len | ref  | rows    | Extra |
+----+-------------+---------+-------+---------------+-----------+---------+------+---------+-------+
|  1 | SIMPLE      | ip_code | index | NULL          | i_ip_head | 5       | NULL | 4514694 |       | 
+----+-------------+---------+-------+---------------+-----------+---------+------+---------+-------+
```
使用索引和不使用索引的执行时间对比，说明mysql在安排执行计划时，未能足够好地优化。
```
+-----------+-----------------+
| use index | without index   |
+-----------+-----------------+
| 10s       | 611s            |
+-----------+-----------------+
```

此处也补充说明一下use index和force index的区别：二者都是对优化器的hint，前者只是在优化器选错索引时提出建议，后者则会使得优化器在能使用索引时就尽量使用索引，避免全表扫描，在对查询有充分把握时才能使用，强行使用索引在某些情况下，可能使得查询性能比全表扫描更差。

## 其他发现
